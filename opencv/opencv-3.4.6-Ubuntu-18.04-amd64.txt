https://docs.nvidia.com/cuda/archive/9.2/cuda-installation-guide-linux/index.html
https://github.com/sylabs/singularity/issues/1292
https://devblogs.nvidia.com/gpu-containers-runtime
https://devblogs.nvidia.com/gpu-containers-runtime/

https://github.com/opencv/opencv/wiki/CPU-optimizations-build-optionsy
https://gist.github.com/raulqf/a3caa97db3f8760af33266a1475d0e5e

opencv 3.4.6


# Best practice
# voir https://singularity.lbl.gov/docs-recipes#best-practices-for-build-recipes

export SINGULARITY_HTTP_PROXY="http://proxy.logti.etsmtl.ca:3128"

cat << EOF > opencv-3.4.6-Ubuntu-18.04-amd64-with-source.def
Bootstrap: docker
From: ubuntu:18.04

%help
     Use the --nv switch.
     With the --nv option the driver libs are located on the host system and then bind mounted into the container at runtime.

%setup
    mkdir ${SINGULARITY_ROOTFS}/download

%files
    
%labels
    Maintainer "Patrice Dion" <patrice.dion@etsmtl.ca>
    Architecture x86_64
    Version v1.0.1

%post

    # set apt proxy
     echo 'Acquire::http::Proxy "http://proxy.logti.etsmtl.ca:3128";' >> /etc/apt/apt.conf
     echo "" >> /etc/apt/apt.conf
     
     export HTTP_PROXY="http://proxy.logti.etsmtl.ca:3128"

    # set noninteractive installation
    export DEBIAN_FRONTEND=noninteractive
    #install tzdata package
    apt-get update
    apt-get install -y tzdata
    # set your timezone
    ln -fs /usr/share/zoneinfo/America/Montreal /etc/localtime
    dpkg-reconfigure --frontend noninteractive tzdata

    apt-get update
    apt-get -y upgrade
    apt-get -y install software-properties-common build-essential cmake wget clang htop
    add-apt-repository universe

    # egl.h, eglext.h, gl31.h, libGLU.so, glu.h,-lglut  
    apt-get -y install freeglut3-dev build-essential libx11-dev libxmu-dev libxi-dev libgl1-mesa-glx libglu1-mesa libglu1-mesa-dev libglfw3-dev libgles2-mesa-dev

    # Pour Pycharm 2019.1, rendering jupyter
    apt-get -y install libxslt1.1
    apt-get -y install libcanberra-gtk-module libcanberra-gtk3-module

    # Install gcc-7
    # voir h ttps://stackoverflow.com/questions/6622454/cuda-incompatible-with-my-gcc-version/8969593
    # apt-get -y install gcc-7 g++-7
    
    
   #
   # opencv 3.4.6
   # voir : https://gist.github.com/raulqf/a3caa97db3f8760af33266a1475d0e5e

   apt-get -y install git wget curl
   apt-get -y install build-essential cmake pkg-config unzip yasm git gfortran
   apt-get -y install libjpeg8-dev libtiff5-dev libpng-dev
   apt-get -y install libavcodec-dev libavformat-dev libswscale-dev
   apt-get -y install libgstreamer1.0-dev libgstreamer-plugins-base1.0-dev
   apt-get -y install libxvidcore-dev x264 libx264-dev libfaac-dev libmp3lame-dev libtheora-dev libvorbis-dev
   apt-get -y install libgtk-3-dev
  
   apt-get -y install python3-dev python3-pip
   pip3 install pip numpy
   apt-get -y install libtbb-dev
   apt-get -y install libatlas-base-dev gfortran

   apt-get -y install libprotobuf-dev protobuf-compiler
   apt-get -y install libgoogle-glog-dev libgflags-dev
   apt-get -y install libgphoto2-dev libeigen3-dev libhdf5-dev doxygen

   apt-get -y install flake8 python3-flake8 pylint3

   # Can't install libjasper-dev libjasper1, o not exist in 18.04
   
   export DPKG_DEPEND="ca-certificates \
	            build-essential \
	            apt-utils \
 	            cmake \
	            git \
	            libgtk2.0-dev \
	            pkg-config \
	            libavcodec-dev \
	            libavformat-dev \
	            libswscale-dev \
	            wget \
	            libhdf5-dev \
	            g++ \
	            graphviz \
	            libtbb2 \
	            libtbb-dev \
	            libjpeg-dev \
	            libpng-dev \
	            libtiff-dev \
	            libgtk-3-dev \
	            libatlas-base-dev \
	            gfortran \
	            openblas-* \
	            libopenblas-dev \
	            libeigen3-dev \
	            ocl-icd-opencl-dev \
	            python3-dev \
	            python3-tk \
	            python3-numpy \
	            python3-scipy \
	            python3-h5py \
	            python3-sympy \
	            libcupti-dev \
	            libgtkglext1-dev \
	            libgtkglext1 \
	            freeglut3-dev \
	            libgl1-mesa-dev \
	            mesa-common-dev \
	            libprotobuf-dev \
	            protobuf-compiler \
	            libleveldb-dev \
	            libhdf5-serial-dev \
	            libboost-dev \
	            libboost-all-dev \
	            libatlas-base-dev \
	            libopencore-amrnb-dev \
	            libopencore-amrwb-dev \
	            libtheora-dev \
	            libvorbis-dev \
	            libxvidcore-dev \
	            liblapacke-dev \
	            libopenni2-dev \
	            libgflags-dev \
	            libgoogle-glog-dev \
	            liblmdb-dev"


for i in ${DPKG_DEPEND}; do apt-get --assume-yes install  $i; done



   cd /download
   git clone https://github.com/opencv/opencv.git
   cd opencv 
   git checkout 3.4.6
   cd ..

   git clone https://github.com/opencv/opencv_contrib.git
   cd opencv_contrib
   git checkout 3.4.6
   cd ..
   
   git clone https://github.com/opencv/opencv_extra.git
   cd opencv_extra
   git checkout 3.4.6
   cd ..

   cd opencv
   mkdir build
   cd build

   export OPENCV_DIR="/usr/local/opencv/3.4.6"

   cmake \
    -D CMAKE_BUILD_TYPE=RELEASE \
    -D BUILD_PYTHON_SUPPORT=ON \
    -D CMAKE_INSTALL_PREFIX=/usr/local/opencv/3.4.6 \
    -D INSTALL_PYTHON_EXAMPLES=ON \
    -D BUILD_PYTHON_SUPPORT=ON \
    -D BUILD_NEW_PYTHON_SUPPORT=ON \
    -D PYTHON_DEFAULT_EXECUTABLE=$(which python3) \
    -D PYTHON_INCLUDE_DIR=/usr/include/python3.6 \
    -D PYTHON_INCLUDE_DIR2=/usr/include/x86_64-linux-gnu/python3.6m \
    -D PYTHON_LIBRARY=/usr/lib/x86_64-linux-gnu/libpython3.6m.so \
    -D PYTHON3_NUMPY_INCLUDE_DIRS=/usr/lib/python3/dist-packages/numpy/core/include/ \
    -D OPENCV_TEST_DATA_PATH=/download/opencv_extra/testdata\
    -D WITH_TBB=OFF \
    -D WITH_PTHREADS_PF=ON \
    -D WITH_OPENNI=OFF \
    -D WITH_OPENNI2=ON \
    -D WITH_EIGEN=ON \
    -D BUILD_DOCS=ON \
    -D BUILD_TESTS=ON \
    -D BUILD_PERF_TESTS=ON \
    -D BUILD_EXAMPLES=ON \
    -D WITH_OPENCL=ON \
    -D WITH_CUBLAS=ON \
    -D USE_GStreamer=ON \
    -D WITH_GDAL=ON \
    -D WITH_CSTRIPES=ON \
    -D ENABLE_FAST_MATH=1 \
    -D WITH_QT=OFF \
    -D WITH_IPP=ON \
    -D WITH_V4L=OFF \
    -D WITH_LIBV4L=ON \
    -D WITH_FFMPEG=0 \
    -D WITH_GSTREAMER=OFF  ..
    

   make

   make install


   # libraries pour le lab
   pip3 --no-cache-dir install virtualenv
   pip3 --no-cache-dir install pytest
   
   pip3 --no-cache-dir install matplotlib     # visualisation
   pip3 --no-cache-dir install seaborn        # visualisation
   pip3 --no-cache-dir install pandas
   pip3 --no-cache-dir install jupyter

   # installation de qt4 pour jupiter (dependance) 
   apt-get install --assume-yes python3-pyqt4


   pip3 --no-cache-dir install bokeh          # visualisation

   # voir http://docs.dask.org/en/latest/install.html
   pip3 --no-cache-dir install "dask[complete]"     # parallel

   pip3 --no-cache-dir install ipython
   pip3 --no-cache-dir install scikit-image
   pip3 --no-cache-dir install scikit-learn>=0.20.3
   pip3 --no-cache-dir install numPy
   pip3 --no-cache-dir install joblib
   pip3 --no-cache-dir install graphviz

   # ImportError: cannot import name create_prmpt_application ipython>6 for prompttoolkit>2
   pip3 install ipython==7.5

 

%test
      # list all available python modules
      python3 -c 'help('modules')'
      
      # is the package installed
      pkg-config opencv --cflags
      pkg-config opencv --libs

      export LD_LIBRARY_PATH=/usr/local/opencv/3.4.6/lib:$LD_LIBRARY_PATH
      python3 -c 'import cv2 as cv ; print(cv.__version__)'

      # test the installation
      export OPENCV_TEST_DATA_PATH=/download/opencv_extra/testdata
      cd /download/opencv/build/bin
      ./opencv_test-core
      ls -al *test*

%runscript
      # https://singularity.lbl.gov/docs-run      
      # exec "$@"
      exec /usr/bin/python3 "$@"

%environment
   export LC_ALL=C

   export LD_LIBRARY_PATH=/usr/local/lib:$LD_LIBRARY_PATH
   export LD_LIBRARY_PATH=/usr/local/opencv/3.4.6/lib:$LD_LIBRARY_PATH

    if [ -z “$PYTHONPATH” ]; then
      PYTHONPATH=/usr/local/opencv/3.4.6/lib/python3.6/dist-packages/
   else
      PYTHONPATH=/usr/local/opencv/3.4.6/lib/python3.6/dist-packages/:$PYTHONPATH
   fi

   export PYTHONPATH=/usr/local/lib/python3.6/dist-packages/:${PYTHONPATH}

   export PKG_CONFIG_PATH=/usr/local/opencv/3.4.6/lib/pkgconfig

   export HTTP_PROXY="http://proxy.logti.etsmtl.ca:3128"

   # jupyter notebook /run/user/1000/
   # Permission issue for /run/user/0/jupyter when I execute jupyter notebook
   # voir https://groups.google.com/forum/#!topic/jupyter/uQ8Jqz4rnu0
   unset XDG_RUNTIME_DIR

EOF


# Building the container

singularity build --notest opencv-3.4.6-Ubuntu-18.04-amd64-with-source.simg  opencv-3.4.6-Ubuntu-18.04-amd64-with-source.def
singularity shell --cleanenv opencv-3.4.6-Ubuntu-18.04-amd64-with-source.simg

#
# build and test de container
#
singularity build --notest --sandbox opencv-3.4.6-Ubuntu-18.04-amd64-with-source/  opencv-3.4.6-Ubuntu-18.04-amd64-with-source.def
singularity shell --writable-tmpfs opencv-3.4.6-Ubuntu-18.04-amd64-with-source/
singularity build --notest opencv-3.4.6-Ubuntu-18.04-amd64-with-source.simg  opencv-3.4.6-Ubuntu-18.04-amd64-with-source/

#
# Installation de package python
#
virtualenv --system-site-packages -p python3 gti770-test
source gti770-test/bin/activate
python3 -c 'import cv2 as cv ; print(cv.__version__)'
pip3 install camelcase


#
# execute as an interpretor
#

singularity exec --nv /singularity/opencv-3.4.6-Ubuntu-18.04-amd64.simg /bin/bash 
singularity exec --nv /singularity/opencv-3.4.6-Ubuntu-18.04-amd64.simg /home/ladmin/venv.sh && python3 --version
singularity exec --nv /singularity/opencv-3.4.6-Ubuntu-18.04-amd64.simg "/home/ladmin/venv.sh ; python3 -c 'import cv2 as cv ; print(cv.__version__)'"


cat python3-singularity.sh
  #!/bin/bash

  #echo $@
  #singularity exec --nv /singularity/opencv-3.4.6-Ubuntu-18.04-amd64.simg /home/ladmin/venv.sh && python3 $@

  singularity exec --nv /singularity/opencv-3.4.6-Ubuntu-18.04-amd64.simg "/home/ladmin/venv.sh"



singularity run --nv /singularity/opencv-3.4.6-Ubuntu-18.04-amd64.simg /bin/bash -c "source gti770-test/bin/activate"; python3 --version

# Run pycharm in the container 
# -H change $HOME to /home/ladmin : default = /usr/local/singularity/3.1.0
singularity shell -B /opt/PyCharm:/opt/PyCharm -B /etc/profile.d/jetbrains-pycharm.sh -H /home/ladmin --nv --writable-tmpfs /singularity/opencv-3.4.6-Ubuntu-18.04-amd64.simg


# enable %runscript
singularity run --nv /singularity/opencv-3.4.6-Ubuntu-18.04-amd64.simg  python3 -c 'import cv2 as cv ; print(cv.__version__)'
singularity run --nv /singularity/opencv-3.4.6-Ubuntu-18.04-amd64.simg  python3 --version

# run python without source activate
venv.sh
    #!/home/ladmin/gti770-test/bin/python3

    import cv2 as cv
    print(cv.__version__)


# voir https://stackoverflow.com/questions/4303128/how-to-use-multiple-arguments-for-awk-with-a-shebang-i-e
#!/usr/bin/env -S command arg1 arg2


# Remove /download directory
#

singularity build --sandbox opencv-3.4.6-Ubuntu-18.04-amd64/ opencv-3.4.6-Ubuntu-18.04-amd64-with-source.simg
rm -Rf  opencv-3.4.6-Ubuntu-18.04-amd64/download
singularity build  opencv-3.4.6-Ubuntu-18.04-amd64.simg opencv-3.4.6-Ubuntu-18.04-amd64/
rm -Rf opencv-3.4.6-Ubuntu-18.04-amd64

